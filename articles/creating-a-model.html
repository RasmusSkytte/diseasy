<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating a model • diseasy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating a model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">diseasy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/diseasy.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Functional modules</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-activity.html">DiseasyActivity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-observables.html">DiseasyObservables</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-season.html">DiseasySeason</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-variant.html">DiseasyVariant</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer guides</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-a-model.html">Creating a model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ssi-dk/diseasy/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Creating a model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ssi-dk/diseasy/blob/feature/cachem-cache/vignettes/creating-a-model.Rmd" class="external-link"><code>vignettes/creating-a-model.Rmd</code></a></small>
      <div class="d-none name"><code>creating-a-model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides an overview of the <code>DiseasyModel</code>
class and its use in creating a <code>diseasy</code> model.</p>
<p>As described in the package introduction
(<code><a href="../articles/diseasy.html">vignette("diseasy")</a></code>), the power of <code>diseasy</code>
comes from combining different “functional” modules with model
“templates” to create a large ensemble of models easily.</p>
<p>It is <code>DiseasyModel</code> that defines how such model templates
should look, and provides the mechanism by which the functional modules
are loaded in the model templates to create the individual model members
of the ensemble.</p>
<p>Before we dive into the details of <code>DiseasyModel</code>, let’s
first consider what it means to be a “model template”:</p>
</div>
<div class="section level2">
<h2 id="model-templates">Model Templates<a class="anchor" aria-label="anchor" href="#model-templates"></a>
</h2>
<p>Developing a model in <code>diseasy</code> involves constructing a
model template that incorporates one or more functional modules into a
model design.</p>
<p>For instance, let’s consider the creation of a simple SIR
(Susceptible, Infectious, Recovered) infection model with a seasonal
forcing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>
of the overall infection rate, denoted by .</p>
<p>The SEIR model with seasonal forcing can be represented by the
following set of differential equations:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mo>−</mo><mi>β</mi><mo>⋅</mo><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\frac{dS(t)}{dt} = - \beta \cdot \sigma(t) \cdot S(t) \cdot I(t)
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>β</mi><mo>⋅</mo><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>γ</mi><mo>⋅</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\frac{dI(t)}{dt} = \beta \cdot \sigma(t) \cdot S(t) \cdot I(t) - \gamma \cdot I(t)
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>R</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>γ</mi><mo>⋅</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\frac{dR(t)}{dt} = \gamma \cdot I(t)
</annotation></semantics></math></p>
<p>When developing this model traditionally, we would choose some
functional form for the seasonal forcing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>,
e.g. a sinusoidal relationship:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>A</mi><mo>⋅</mo><mo>cos</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>⋅</mo><mi>t</mi><mo>+</mo><mi>ϕ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\sigma(t) = A \cdot \cos(k \cdot t + \phi)
</annotation></semantics></math></p>
<p>The strategy of <code>diseasy</code> is to source the seasonal
forcing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>
directly from the corresponding functional module
(<code>DiseasySeason</code>).</p>
<p>Every implementation of a seasonal forcing in
<code>DiseasySeason</code> has the same function signature (i.e. they
all take only a single argument
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
once configured).</p>
<p>This way, we can configure different instances of
<code>DiseasySeason</code> using the whole range of (available)
plausible functional forms of seasonal forcing:</p>
<ul>
<li>No seasonal forcing
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sigma(t) = 1</annotation></semantics></math>)</li>
<li>Sinusoidal forcing</li>
<li>Temperature dependent forcing</li>
<li>Other plausible seasonal forcing forms</li>
</ul>
<p>Since the modules of <code>diseasy</code> are “objects” in an
object-oriented-programming sense, the functional forms of the seasonal
forcing can have parameters (as we see in the list above), but these are
stored in the object when configuring the module, and the actual
seasonal forcing exposed to the models all have the same function
signature that takes only time as input
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;The seasonal model exposed by a configured
&lt;code&gt;DiseasySeason&lt;/code&gt; instance is a “closure” instead of a pure
function.&lt;/p&gt;"><sup>1</sup></a>.</p>
<p>This way, we can easily swap out different seasonal forcing models in
our model templates without having to change the model equations
themselves. If new seasonal forcing models are developed, they are then
automatically available to the developed model.</p>
<p>This is the philosophy behind the <code>diseasy</code> package, since
we can easily swap out different functional modules for the templates
and generate a large ensemble of models with functional forms for the
disease dynamics.</p>
</div>
<div class="section level2">
<h2 id="the-diseasymodel-class">The <code>DiseasyModel</code> class<a class="anchor" aria-label="anchor" href="#the-diseasymodel-class"></a>
</h2>
<p>To create a model template in <code>diseasy</code> is to create a new
class that inherits the <code>DiseasyModel</code> class.</p>
<p>This gives the model template access to the functional modules that
are available in the package, it defines how the user sets the
parameters of the model and queries the model for results.</p>
<p>In addition, it provides useful utilities for the implementation of
the model such as logging and caching.</p>
<div class="section level3">
<h3 id="a-container-for-functional-modules">A container for functional modules<a class="anchor" aria-label="anchor" href="#a-container-for-functional-modules"></a>
</h3>
<p>The <code>DiseasyModel</code> class contains slots for instances of
functional modules:</p>
<ul>
<li>
<code>$activity</code>: <code>{DiseasyActivity}</code>
</li>
<li>
<code>$observables</code>: <code>{DiseasyObservables}</code>
</li>
<li>
<code>$season</code>: <code>{DiseasySeason}</code>
</li>
<li>
<code>$variant</code>: <code>{DiseasyVariant}</code>
</li>
</ul>
<p>This means, that once a new <code>DiseasyModel</code> instance is
created, it will have the functional modules internally available. Going
back to the above example of the SIR model with seasonal forcing, the
model template would be access the seasonal forcing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>
via the call <code>self$season$model_t(t)</code>.</p>
</div>
<div class="section level3">
<h3 id="training-data">Training data<a class="anchor" aria-label="anchor" href="#training-data"></a>
</h3>
<p>The <code>DiseasyModel</code> class also contains the method
<code>$get_training_data()</code> that provides training data to the
models.</p>
<p>This method interfaces with the <code>DiseasyObservables</code>
module to provide data for an observable at some stratification level.
The level of stratification is generally a flexible parameter that will
be set by the user when requesting results from the model. For example,
the user my request results at the country level or at the regional
level.</p>
<p>The helper method <code>$get_training_data()</code> will then provide
the training data for the observable at the requested level. This data
will contain one record for each time point in the training period, with
columns for the date of the observation, the values of the different
(optional) stratification, and the value of the observable on the date,
and finally, an integer counter for the day relative to the end of the
training period.</p>
</div>
<div class="section level3">
<h3 id="model-user-interface">Model-user interface<a class="anchor" aria-label="anchor" href="#model-user-interface"></a>
</h3>
<p>Beyond providing access to the functional modules,
<code>DiseasyModel</code> defines how the user will interface with the
model.</p>
<div class="section level4">
<h4 id="setting-parameters">Setting parameters<a class="anchor" aria-label="anchor" href="#setting-parameters"></a>
</h4>
<p>The default parameters of the model should be contained within the
<code>$parameters</code> slot of the model template.</p>
<p>These are then exposed to the user, and logic can be implemented to
allow the user to set some parameters of the model while leaving others
free to be determined by the model during model fitting.</p>
<p>For technical reasons<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In R6, functions from superclasses are available via the
&lt;code&gt;super&lt;/code&gt; keyword but non-function objects are not. by
implementing the &lt;code&gt;private$default_parameters&lt;/code&gt; slot as a
function, we can ensure that the parameters from the superclasses are
available to the model template.&lt;/p&gt;"><sup>2</sup></a>, you should implement the
<code>private$default_parameters()</code> slot as a function that
combines the model-specific parameters with the inherited parameters
from the superclasses.
<code>{r .parameters implementation, eval = FALSE}                                                                         # nolint: assignment_linter, object_usage_linter default_parameters = function() {   modifyList(     super$default_parameters(), # Obtain parameters from the superclasses     # Overwrite with model-specific parameters     list("model_specific_param_1" = 1, "model_specific_param_2" = "method_1"),     keep.null = TRUE   ) }</code>
# nolint end During initialisation, these are then evaluated to a single
list of parameters, updated with the user-specified values for the
parmaters and stored in the <code>private$.parameters</code> slot. The
parameters are then acccessable via <code>$parameters</code>.</p>
<div class="section level5">
<h5 id="validating-the-parameters">Validating the parameters<a class="anchor" aria-label="anchor" href="#validating-the-parameters"></a>
</h5>
<p>The model template can test the user provided <code>parameters</code>
by implementing the <code>private$validate_parameters()</code> method.
Note that some parameters may be set inherited from superclasses, so the
implementation of the <code>$validate_parameters()</code> method should
also call the parent validation method
(<code>super$validate_parameters()</code>).</p>
<p><code>{r .parameter validation implementation, eval = FALSE}                                                               # nolint: assignment_linter, object_usage_linter validate_parameters = function() {   checkmate::assert_number(self$parameters$model_specific_param_1)   checkmate::assert_choice(     self$parameters$model_specific_param_2,     c("method_1", "method_2")   )   super$validate_parameters() }</code>
# nolint end</p>
</div>
</div>
<div class="section level4">
<h4 id="getting-results">Getting results<a class="anchor" aria-label="anchor" href="#getting-results"></a>
</h4>
<p>Once the parameters of the model is set (either by the user or by the
model), the user can query the model for results using the
<code>$get_results()</code> function. Through this function, the user
provides the parameters of the result that should be provided (target
observable, time-window and stratification level). In return, the
function returns a standardised <code>data.frame</code>-like output that
can be used for further analysis in conjunction with the results from
other models.</p>
<p>The outputs of the model are standardised, and should follow the
structure of the <code>training_data</code> provided by
<code>$get_training_data()</code> enriched by model prediction, model id
and realization id.</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rasmus Skytte Randløv, Marcus Munch Grünewald, Lasse Engbo Christiansen, Kaare Græsbøll, <a href="https://www.ssi.dk/" class="external-link"><img src="https://www.ssi.dk/assets/images/ssi-logo-optimeret.svg" alt="SSI" height="64" style="margin-bottom: 0.5em; margin-top: 1.5em;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
