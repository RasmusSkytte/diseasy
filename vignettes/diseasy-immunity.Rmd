---
title: "DiseasyImmunity"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DiseasyImmunity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(diseasy)
devtools::load_all()
```

```{r options, include = FALSE}
options("digits" = 2)
options("tibble.print_min" = 5)
options("diseasy.logging" = FALSE)
```

# Introduction
The `DiseasyImmunity` is a module designed to implement various models for the waning of immunity against a disease.

# Configuring the module
The module can be initialized without setting any parameters, with the following code:
```{r initialization}
im <- DiseasyImmunity$new()
```

# Inspecting the module
By default, the module initializes with the `no_waning` model (that is, constant, perfect immunity) stored under the
target "infection".

To check the currently set targets and associated models, you can use the following code.
```{r model}
im$model
```
This returns a `named list()` where the named target are modelled by the corresponding function.


To see the available waning models within the module, query the module as shown below:
```{r available_models}
im$available_waning_models
```

# Setting a waning model in the module

The input for the predefined waning models include:

- `target`: The specific aspect towards which immunity is waning, such as "infection".
- `time_scale`: A characteristic time scale, which defines the period until when the immunity is significantly waning.
  Note that the `no_waning` model does not have a time scale parameter.

The name of the chosen target is arbitrary within the context of the `DiseasyImmunity` module, but models within the
`diseasy` framework may expect named targets such as "infection", "hospitalisation", or "death".

Here is an example of how to set the exponential waning model.
```{r setting the models}
im$set_exponential_waning(time_scale = 20, target = "infection")
```
To inspect that the model has been set correctly use `im$model`

To visualize the model, the plot function provided by the module can be used:
```{r plot_1}
plot(im)
```

Besides the predefined functions, you can also create a custom waning function.

The input for the custom waning function includes:

- `custom_function`: A function defining how immunity wanes over time.
  It should take time (t) as a parameter and also include `time_scale` in the function expression.
- `time_scale`: A characteristic time scale, which defines the period until when the immunity is significantly waning.
- `target`: The specific aspect towards which immunity is waning, such as e.g. infection, hospitalisation, or death.
- `name`: A name for the custom function, used for identification. Default is "custom_waning".

Here is an example of setting a custom waning function:
```{r custom waning function}
im$set_custom_waning(custom_function = \(t) 1 / (1 + exp((t - time_scale) / time_scale)),
                     time_scale = 30,
                     target = "hospitalisation",
                     name = "custom_waning")
```

To visualize all the functions in the model, use the same plot function as above:
```{r plot_2}
plot(im)
```

## Setting the waning model programmatically
`DiseasyImmunity` also provides the `$set_waning_model()` function which allows greater flixibility when configuring
various waning models within the module.

`$set_waning_model()` provides a single entry-point for setting the predefined waning models or a custom waning
function based on the specified `model` and `target`.

If `model` is a `function`, it will be set as a custom waning function via `$set_custom_waning()`.
If instead it is `character`, the corresponding to `$set_<model>()` method will be used to set the waning model.

Input for both predefined models and custom waning functions can be passed to the `$set_waning_model()` as additional
arguments.

An example of how to set they two model examples from above, using the `$set_waning_model()` is as follows:
```{r set waning models function}
im$set_waning_model(model = "exponential_waning", time_scale = 20, target = "infection")
im$set_waning_model(model = \(t) 1 / (1 + exp((t - time_scale) / time_scale)),
                    time_scale = 30,
                    target = "hospitalisation",
                    name = "custom_waning")
```

# Changing the time scale
It is also possible to change the characteristic time scale after setting the model.

This is done via the method `$set_time_scales()` which takes a named list as input and changes time scales of waning
functions associated with the named targets.

Following is an example of how to change the time scale for the two targets in the current models.
```{r setting the time scale}
im$set_time_scales(list("infection" = 30, "hospitalisation" = 100))
```

# Approximating to a compartmental model
`DiseasyImmunity` can also provide the approximations of the waning models for compartmental ODE models.
(e.g. the Susceptible-Infected-Recovered-Susceptible (SEIR) models).

The approximation assumes the model has a number of sequential R compartments and then provides the transition rates
and associated risks for each compartment that best approximates set waning functions.

Some definitions:

- Flow between compartments: The transition rate between compartments $n$ and $n+1$ is defined as $\delta_n$.
- Risk associated with compartments: The protective effect associated with compartment $n$ is defined as $\gamma_n$,
  which represents the probability of not becoming infected when exposed to an infected individual.

Three approaches are available for determining the transition rates, $\delta_n$, and protective effect, $\gamma_n$,
that best approximates the set waning functions:

- Approach 1: (`rate_equal`) - $\gamma_n$ values are allowed to vary freely, while the $\delta_n$ rates are equal
  between compartments ($\delta_n = \delta$).
- Approach 2: (`gamma_fixed_step`) - $\gamma_n$ values are monotonically decreasing ($\gamma_n = (n-1)/(N-1)$),
  and $\delta_n$ are allowed to vary freely.
- Approach 3: (`all_free`) -  Both $\gamma_n$ and $\delta_n$ are allowed to vary freely.

These methods help approximate all the models in the current instance of the module.

The input for the `$approximate_compartmental()` function includes:

- `approach`: One of the approaches from above - "rate_equal", "gamma_fixed_step" or "all_free".
- `N`: The number of compartments to use for the approximation.

In this example the module contains the infection and hospitalisation targets defined earlier, which will be
approximated.
```{r approximate compartmental}
im$approximate_compartmental(method = "free_gamma", N = 5)
```

To visualize how the approximations compare to the target functions, the plot function can be used.
Simply specify the approach and the number of compartments (`N`).
The plot will display both the approximations and the target functions for comparison.
```{r plot approximation}
im$plot(approach = "rate_equal", N = 5)
```

# Compartment selection (elbow curve method)
The accuracy of the approximation can be influenced by the number of compartments (`N`) used in the model.
Therefore it is crucial to select the right N as too few compartments can lead to poor approximation,
while too many compartments can lead to unnecessary computational time without significant improvement in accuracy.
The elbow curve method is employed to determine the appropriate N for the models.
Each approach is executed across a range of N values, and the resulting objective function values are returned as `value` from the approximate_compartmental function.
```{r prepare elbow curve}
rm(im)
devtools::load_all()
im <- DiseasyImmunity$new(cache = cachem::cache_disk(dir = devtools::package_file("vignettes/vignette_data")))
```

```{r elbow curve method}
# Prepare the data
N_seq <- seq(from = 1, to = 10, by = 1)                                                                                 # nolint: object_name_linter
approaches <- c("rate_equal", "gamma_fixed_step")#, "all_free")
im$set_heaviside_waning(time_scale = 20, target = "infection")

# Run each function
results <- tidyr::expand_grid(
  approach = approaches,
  N = N_seq
) |>
  purrr::pmap(
    \(approach, N) {                                                                                                    # nolint: object_name_linter
      im$approximate_compartmental(approach = approach, N = N) |>
        purrr::pluck("value") |>
        stats::setNames(glue::glue("{approach}-{N}"))
    },
    .progress = interactive()
  )

# Convert to data frame
results <- results |>
  purrr::list_c() |>
  tibble::enframe() |>
  tidyr::separate_wider_delim("name", delim = "-", names = c("approach", "N"))

# Plot
ggplot2::ggplot(results, ggplot2::aes(x = N, y = value, color = approach, group = approach)) +
  ggplot2::geom_line() +
  #ggplot2::xlim(1, max(results$N)) +
  ggplot2::scale_y_log10() +
  ggplot2::labs(x = "N", y = "Error") +
  ggplot2::theme_minimal()
```
